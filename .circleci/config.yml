# Golang CircleCI 2.0 configuration file
# Check https://circleci.com/docs/2.0/language-go/ for more details
version: 2.1

orbs:
  aws-ecr: circleci/aws-ecr@6.14.0

jobs:
  test:
    docker:
      - image: circleci/golang:1.14
    working_directory: /go/src/github.com/bcmdarroch/go-sample
    steps:
      - checkout
      - run: go mod download
      - run: echo "✧✧✧ Running Go tests ✧✧✧"
      - run: go test -v ./...  
  build:
    docker:
      # specify the version
      - image: circleci/golang:1.14

    working_directory: /go/src/github.com/bcmdarroch/go-sample
    steps:
      - checkout
      - run: echo "✧✧✧ Downloading deps ✧✧✧"
      # specify any bash command here prefixed with `run: `
      - run: go mod download
      # TODO: build the binary and creates docker iamge
  release:
    docker:
      - image: circleci/golang:1.14 # TODO: find an image that has both go and aws installed (look on docker hub)
    working_directory: /go/src/github.com/bcmdarroch/go-sample
    steps:
      - checkout
      - setup_remote_docker
      - run: echo "✧✧✧ Building latest release ✧✧✧"
      # - run: aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 689767776207.dkr.ecr.us-west-2.amazonaws.com
      - run: docker image build -t 689767776207.dkr.ecr.us-west-2.amazonaws.com/hello:$CIRCLE_TAG .
      # - run: docker push 689767776207.dkr.ecr.us-west-2.amazonaws.com/hello:$CIRCLE_TAG
  ecr_push:
    docker:
      - image: circleci/aws-cli:1.2.1
    steps:
      - setup_remote_docker
      - run: docker images 102179876835.dkr.ecr.us-east-1.amazonaws.com/hello
# Under the workflows: map, we can coordinate our two jobs, defined above.
workflows:
  version: 2
  feature_branch: # this is the name of our workflow
    jobs: # and here we list the jobs we are going to run.
      - test:
          filters:
            tags:
              only: /^v.*/
      # unnecessary now that we're using aws-ecr orb below: 
      # - build:
      #     requires:
      #       - test
      # - release:
      #     requires:
      #       - test
          # filters:
          #   tags:
          #     only: /^v.*/
          #   branches:
          #     ignore: /.*/
      - aws-ecr/build-and-push-image: # uses orb predefined job 
          region: us-east-1
          account-url: 102179876835.dkr.ecr.us-east-1.amazonaws.com
          repo: hello
          tag: ${CIRCLE_TAG}
          requires:
            - test
          # filters:
          #   tags:
          #     only: /^v.*/
          #   branches:
          #     ignore: /.*/

          # TODO: we'll add another workflow for releases, which runs test job and builds and push 
          # (feat branch will just run test)